<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>Pair config</title>

<script type="text/javascript" src="data.js"></script>
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="ui.js"></script>
<script type="text/javascript">
{

var param = {};
var data = {};

function hasClass(elem, className) {
        return new RegExp("(^|\\s)"+className+"(\\s|$)").test(elem.className);
}
function $(id) {
	return (typeof id == "string" ) ? document.getElementById(id) : id;
}
function trims (val) {
	return val.replace(/^\s+|\s+$/g,'');
}
function isnum(val) {
	return !isNaN(+val);
}
function printErr (msg) {
	alert(msg);
	return false;
}

function checkInput() {
	var out = {};
	var fidn, fidv, el;

	for (var j=0; j<$("connection").rows.length; j++) {
		el = $("connection").rows[j];
		var fval = el.cells[1].firstChild;
		fidn = fval.id;

		if (fval.style.display == "none") 	fval = fval.nextSibling;
		if (fval.tagName == "INPUT") {
			fidv = trims(fval.value);
			if (!hasClass(fval, "canbenull") && (fidv.length == 0)) return printErr("Empty value in " + el.cells[0].innerHTML.replace(/&nbsp;/g, " "));
			if (hasClass(fval, "int") && !isnum(fidv)) return printErr("Invalid value in " + el.cells[0].innerHTML.replace(/&nbsp;/g, " "));
		} else {
			if (fval.selectedIndex == -1 || !fval.options[fval.selectedIndex].value) return printErr("State is not selected");
			fidv = fval.options[fval.selectedIndex].value;
		}

// special case for source and description fields
		if ((fidn == "source" || fidn == "description") && fidv == "*") return printErr("Asterix symbol '*' is not allowed for " + fidn);
		out[fidn] = fidv; 
	}
	if ($("share").rows.length == 1) return printErr("At least one VO and active fields should be defined");

	out.share = [];
	el = $("share");

	for (var i=1; i<el.rows.length; i++) {
		var tshare = {};
		tshare.vo = el.rows[i].cells[0].innerHTML;
		tshare.active = el.rows[i].cells[1].firstChild.value;
		out.share.push(tshare);
	}
	return out;
}

function setName(fld) {
	var oth, str1, str2;
	if (fld.id.substr(-6) == "source") {
		str1 = (fld.tagName == "INPUT") ? trims(fld.value) : fld.options[fld.selectedIndex].value;
		oth = "destination";
		str2 = ($(oth).style.display == "block") ? trims($(oth).value) : $("sel_" + oth).options[$("sel_" + oth).selectedIndex].value ;
	} else {
		str2 = (fld.tagName == "INPUT") ? trims(fld.value) : fld.options[fld.selectedIndex].value;
		oth = "source";
		str1 = ($(oth).style.display == "block") ? trims($(oth).value) : $("sel_" + oth).options[$("sel_" + oth).selectedIndex].value;
	}

	$("symbolicname").value = str1 + "->" +  str2;
	return true;
}

function switchName(name) {
	var els = document.getElementsByName(name);
	for (var i=0; i<els.length; i++) {
		if (els[i].checked) {
			if (els[i].value == "1") {
				$("sel_source").style.display = "block";
				$("sel_destination").style.display = "block";
				$("source").style.display = "none";
				$("destination").style.display = "none";
			} else {
				$("sel_source").style.display = "none";
				$("sel_destination").style.display = "none";
				$("source").style.display = "block";
				$("destination").style.display = "block";
			}
			break;
		}
	}
	return true;
}
function closeWin(){
	if (window.opener.wndPop)	{
		window.opener.focus();
		window.opener.wndPop = null;
		setTimeout(function(){window.close()}, 100); // KHTML workaround
	}
	return true;
}

function add_new_share(tb) {
	var trow = tb.rows[0];
	var dt = {};

	dt.vo = trims(trow.cells[0].firstChild.value);
	dt.active = trims(trow.cells[1].firstChild.value);
	if (!dt.vo || !dt.active) return printErr("VO and active fields could not be empty");
	if (!isnum(dt.active), false) return printErr("Invalid active value");
	for (var i=1; i<tb.rows.length; i++) {
		if (tb.rows[i].cells[0].innerHTML.toLowerCase() == dt.vo.toLowerCase()) return printErr("Duplicated VO name");
	}
	add_share(tb, dt);
	trow.cells[0].firstChild.value = "";
	trow.cells[1].firstChild.value = "";
	return true;
}

function add_share(tb, dt) {
	var trow, tcell, tinp, tlink, timg;
	if (!dt.vo) return false;

	trow = tb.insertRow(-1);
	tcell = trow.insertCell(-1);
	tcell.innerHTML = dt.vo.toLowerCase();
	tcell = trow.insertCell(-1);
	tinp = document.createElement("INPUT");
	tcell.appendChild(tinp);
	tinp.size = "10";
	tinp.value = dt.active;
	tcell = trow.insertCell(-1);
	tlink = document.createElement("A");
	tlink.onclick = function() {tb.deleteRow(trow.rowIndex-1)};
	tcell.appendChild(tlink);
	timg = document.createElement("IMG");
	timg.src = "img/minus.gif";
	timg.width = "13";
	timg.height = "13";
	tlink.appendChild(timg);
	return true;
}

function saveData() {
	var i,j;
	var se = {};
	var out = checkInput();
	if (typeof out == "boolean") return false;

	var req0={};
	req0.cmd = "cmdSelect";
	req0.query = queries["t_se_all"] + " order by " + sorts["t_se_all"];
	req0.bind = 0;

// select all se from t_se table for source/destination existence check
	var ret0 = ui_req_s("cmdSelect", req0);
	if (typeof ret0 == "number") return printErr("CGI error " + ret0);
	if (ret0.status != 0) {
		return printErr("Error : " + ret0.retMsg + "\nReason : " + ret0.retNative );
	} else {
		for (i=0; i<ret0.rowNum; i++) {
			se[ret0.data[i].name] = i;
		}
	}


	var req = {"cmdPack":[]};
	var ind = 0;
	with (out) {
		if (param.mode == "ins") {
//insert new link
			req.cmdPack[ind] = {cmd:"insert", table:"t_link_config"};
			req.cmdPack[ind].cols = ["source","destination","state", "symbolicname", "nostreams", "tcp_buffer_size", "urlcopy_tx_to", "no_tx_activity_to"];
			req.cmdPack[ind++].vals = [source, destination, state, symbolicname, nostreams, tcp_buffer_size, urlcopy_tx_to, no_tx_activity_to];

// check and process if source/destination exist
			if (typeof se[out.source] == "undefined") {
				req.cmdPack[ind] = {cmd:"insert", table:"t_se"};
				req.cmdPack[ind].cols = ["name","state"];
				req.cmdPack[ind++].vals = [out.source, "on"];
			}

			if (typeof se[out.destination] == "undefined") {
				req.cmdPack[ind] = {cmd:"insert", table:"t_se"};
				req.cmdPack[ind].cols = ["name","state"];
				req.cmdPack[ind++].vals = [out.destination, "on"];
			}

			if (typeof out.share != "undefined") {
// insert all shares if they exist
				for (j=0; j<share.length; j++) {
					req.cmdPack[ind] = {cmd:"insert", table:"t_share_config"};
					req.cmdPack[ind].cols = ["source","destination", "vo", "active"];
					req.cmdPack[ind++].vals = [source, destination, share[j].vo, share[j].active];
				}		
			}		
		} else {
// update link
			req.cmdPack[ind] = {cmd:"update", table:"t_link_config"};
			req.cmdPack[ind].cols = ["symbolicname","state","nostreams", "tcp_buffer_size", "urlcopy_tx_to", "no_tx_activity_to"];
			req.cmdPack[ind].vals = [symbolicname, state, nostreams, tcp_buffer_size, urlcopy_tx_to, no_tx_activity_to];
			req.cmdPack[ind].keyNames = ["source", "destination"];
			req.cmdPack[ind++].keyValues = [source, destination];
// delete all shares for link
			req.cmdPack[ind] = {cmd:"delete", table:"t_share_config"};
			req.cmdPack[ind].keyNames = ["source","destination"];
			req.cmdPack[ind++].keyValues = [source,destination];

			if (typeof out.share != "undefined") {
				for (j=0; j<share.length; j++) {
// inser all shares if they exist
					req.cmdPack[ind] = {cmd:"insert", table:"t_share_config"};
					req.cmdPack[ind].cols = ["source","destination", "vo", "active"];
					req.cmdPack[ind++].vals = [source, destination, share[j].vo, share[j].active];
				}
			}		
		}		
	}

	var ret = ui_req_s("cmdModify", req);
	if (typeof ret == "number") {                                                            
		alert("CGI Error " + ret);
		return false;                                                                    
	}
	if (ret.status != 0) {
		alert ("Error : " + ret.retMsg + "\nReason : " + ret.retNative + "\n" + ret.query+ "\n" + ret.bind);
		return false;
	}
	if (param.mode == "ins") {
		window.opener.gtables["t_config_pair"].refreshData();
		window.opener.gtables["t_se"].refreshData();
	} else {
//		window.opener.gtables["t_config_pair"].refreshRow(out, param["ind"]);
		window.opener.gtables["t_config_pair"].refreshData();
	}
	closeWin();
	return;
}

function init() {
	var tmp1={};
	var tmp2={};
	var el, i ,j;

	var path = decodeURI(location.search.toString());
	i = path.indexOf("?");
	if(i == -1) return false;

	tmp1 = (path.substr(1)).split('&');
	for(i=0; i < tmp1.length; i++){
		tmp2 = tmp1[i].split('=');
		param[tmp2[0]] = tmp2[1];
	}

	if (param.mode == "ins") {
		$("source").disabled = false;
		$("destination").disabled = false;
		$("src_grp").style.display = "block";

		var req={};
		req.cmd = "cmdSelect";
		req.query = queries["t_groups_all"] + " order by " + sorts["t_groups_all"];
		req.bind = 0;
		var ret = ui_req_s("cmdSelect", req);
		if (typeof ret == "number") return;
		if (ret.status != 0) {
			alert ("Error : " + ret.retMsg + "\nReason : " + ret.retNative );
		} else {
			if (ret.rowNum == 0) return true;
			var lists = ["sel_source","sel_destination"];
			for (j=0; j<lists.length; j++) {
				for (i=0; i<=ret.data.length; i++) {
					var opt = document.createElement("OPTION");
					if (i == 0){
						opt.text = "";
						opt.value = "";
						opt.selected = true;		// Empty by default
					} else {
						opt.text = ret.data[i-1].groupname;
						opt.value = ret.data[i-1].groupname;
					}
					try {
						$(lists[j]).add(opt, null);
					} catch(e) {
						$(lists[j]).add(opt);
					}
				}
			}
		}
		return true;
	}
	data = JSON.parse(param["data"]);
	var tb = $("connection");
	for ( j=0; j<tb.rows.length; j++) {
		el = tb.rows[j].cells[1].firstChild;
		var st = el.id;
		if (el.tagName == "INPUT") {
			el.value = data[st];
		} else {
			for (k=0; k<el.options.length; k++) {
				if (el.options[k].value == data[st]) {
					el.options[k].selected = true;
					break;
				}
			}
		}
	}

	tb = $("share");
	for (j=0; j<data.share.length; j++) {
		add_share(tb, data.share[j]);		
	}

	if (param.mode == "del") {
		$("curtain").style.display = "block";
		if (confirm("Current pair configuration and all associated data will be deleted.\nAre you agree?")) {
			var req = {"cmdPack":[]};
			var ind = 0;
			with (data) {
// delete all shares for pair
				req.cmdPack[ind] = {cmd:"delete", table:"t_share_config"};
				req.cmdPack[ind].keyNames = ["source","destination"];
				req.cmdPack[ind++].keyValues = [source,destination];

// delete pair config
				req.cmdPack[ind] = {cmd:"delete", table:"t_link_config"};
				req.cmdPack[ind].keyNames = ["source","destination"];
				req.cmdPack[ind++].keyValues = [source,destination];
			}
			var ret = ui_req_s("cmdModify", req);
			if (typeof ret == "number") {
				alert("CGI Error " + ret);
			} else if (ret.status != 0) {
				alert ("Error : " + ret.retMsg + "\nReason : " + ret.retNative );
			} else {	
//				window.opener.gtables["t_config_pair"].delRow(param["ind"]);
				window.opener.gtables["t_config_pair"].refreshData();
			}
		}
		closeWin();
	}
	return true;
}
}
</script>
<style>

html {
        overflow: auto;
}
body{
        font-family: Verdana, Arial, Helvetica, sans-serif;
        font-size: 0.9em;
        text-align:justify;
        color:darkblue;
        background-color:#CCFFCC;
}

table.out{
	border: 0;
	width: 100%;
	margin-left: auto;
	margin-right: auto;
}

table.out td{
	border: 1px solid;
	vertical-align: top;
}

table.in{
	border:  0;
	width: 100%;
	margin-left: 0;
	margin-right: 0;
}
table.in td{
	border:  0;
	vertical-align: top;
}

th.center {
	text-align: center;
}
#curtain {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    z-index: 999; /* to avoid overlapping with other elements */
    background: gainsboro;
    opacity: 0.1;
    display: none;
}

</style>

</head><body onload="init()">
<div id="curtain"></div>
<form>
<table class="out">
<tbody>
<tr>
	<td colspan="2">
	<table class="in">
	<tbody id="connection">
		<tr><td>Source</td><td><input type="text" size="30" style="display:block" disabled="true" onchange="setName(this)" id="source" /><select size="1" style="width:260px;display:none" id="sel_source" onchange="setName(this)"></select></td>
		<td rowspan="2">
			<table class="in" id="src_grp" style="display:none">
			<tbody>
				<tr><td><input type="radio" name="source" value="1" onclick="switchName(this.name)" />Groups</td></tr>
				<tr><td><input type="radio" name="source" value="0" checked="true" onclick="switchName(this.name)"/>Single SEs</td></tr>
			</tbody></table>
		</td></tr>
		<tr><td>Destination</td><td><input type="text" size="30" style="display:block" disabled="true" onchange="setName(this)" id="destination"/><select size="1" style="width:260px;display:none" id="sel_destination" onchange="setName(this)"></select></td>
		</tr>
		<tr><td>Name</td><td colspan="2"><input type="text" size="30" id="symbolicname" /></td></tr>
		<tr><td>State</td><td colspan="2"><select id="state" ><option value="" selected></option><option value="on">on</option><option value="off">off</option></select></td></tr>
		<tr><td>Number&nbsp;of&nbsp;streams</td><td colspan="2"><input type="text" size="10" class="int" id="nostreams" /></td></tr>
		<tr><td>TCP&nbsp;buffer&nbsp;size</td><td colspan="2"><input type="text" size="10" class="int canbenull" id="tcp_buffer_size" /></td></tr>
		<tr><td>Timeout</td><td colspan="2"><input type="text" size="10" class="int" id="urlcopy_tx_to" /></td></tr>
		<tr><td>No activity timeout</td><td colspan="2"><input type="text" size="10" class="int canbenull" id="no_tx_activity_to"/></td></tr>
	</tbody>
	</table>
	</td>
</tr>
<tr><th colspan="2">Share</th></tr>
<tr>
	<td colspan="2">
	<table class="in">
	<thead><tr><th>VO</th><th>Active</th><th>&nbsp;</th></tr></thead>
	<tbody id="share">
		<tr><td><input type="text" size="10" style="backgroundColor:#FFFF66" /></td><td><input type="text" size="10" style="backgroundColor:#FFFF66" /></td><td width="0"><a id="add" onclick="add_new_share(this.parentNode.parentNode.parentNode)"><img src="img/plus.gif" width="13px" height="13px"/></a></td></tr>
	</tbody>
	</table>
	</td>
</tr>
<tr><th class="center"><input type="button" value="Save" onclick="saveData()" /></th><th class="center"><input type="button" value="Cancel" onclick="closeWin()" /></th></tr>
</tbody></table>
</form>
</div>
</body></html>
