<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>Groups and their members</title>

<script type="text/javascript" src="data.js"></script>
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="ui.js"></script>
<script type="text/javascript">
{

var param = {};
var data = {};

function $(id) {
	return (typeof id == "string" ) ? document.getElementById(id) : id;
}
function trims (val) {
	return val.replace(/^\s+|\s+$/g,'');
}
function printErr (msg) {
	alert(msg);
	return false;
}

function checkInput() {
	var out = {};
	var fidv, el;

	var groupname = trims($("groupname").value);
	if (groupname.length == 0)  return printErr("Empty group name");
	out.groupname = groupname;

	if ($("group").rows.length < 3) return printErr("At least one group member should be defined");
	out.members=[];
	for (var j=2; j<$("group").rows.length; j++) {
		var mb={};
		el = $("group").rows[j];
		var fval = el.cells[1].firstChild;
		fidv = trims(fval.value);
		if (fidv == "") return printErr("Empty group member name"); 
		mb.member = fidv;
		out.members.push(mb);
	}
	return out;
}

function closeWin(){
	if (window.opener.wndPop)	{
		window.opener.focus();
		window.opener.wndPop = null;
		setTimeout(function(){window.close()}, 100); // KHTML workaround
	}
	return true;
}

function add_new_member(tb) {
	var trow = tb.rows[1];
	var mbr = "";

	mbr = trims(trow.cells[1].firstChild.value);
	if (mbr == "") return printErr("Group member name could not be empty");
	for (var i=2; i<tb.rows.length; i++) {
		if (tb.rows[i].cells[1].firstChild.value == mbr) return printErr("Duplicated member name");
	}
	add_member(tb, mbr);
	trow.cells[1].firstChild.value = "";
	return true;
}

function add_member(tb, mbr) {
	var trow, tcell, tlink, timg;
	if (!mbr) return false;

	trow = tb.insertRow(-1);
	tcell = trow.insertCell(-1);
	tcell.innerHTML = "&nbsp;";
	tcell = trow.insertCell(-1);
	tinp = document.createElement("INPUT");
	tcell.appendChild(tinp);
	tinp.size = "30";
	tinp.value = mbr;
	tcell = trow.insertCell(-1);
	tlink = document.createElement("A");
	tlink.onclick = function() {tb.deleteRow(trow.rowIndex)};
	tcell.appendChild(tlink);
	timg = document.createElement("IMG");
	timg.src = "img/minus.gif";
	timg.width = "13";
	timg.height = "13";
	tlink.appendChild(timg);
	return true;
}

function saveData() {
	var i,j;
	var se = {};
	var out = checkInput();
	if (typeof out == "boolean") return false;
	
	var req0={};
	req0.cmd = "cmdSelect";
	req0.query = queries["t_se_all"] + " order by " + sorts["t_se_all"];
	req0.bind = 0;

// select all se from t_se table for member existence check
	var ret0 = ui_req_s("cmdSelect", req0);
	if (typeof ret0 == "number") return printErr("CGI error " + ret0);
	if (ret0.status != 0) {
		return printErr("Error : " + ret0.retMsg + "\nReason : " + ret0.retNative );
	} else {
		for (i=0; i<ret0.rowNum; i++) {
			se[ret0.data[i].name] = i;
		}
	}
	var req = {"cmdPack":[]};
	var ind = 0;
	with (out) {
		if (param.mode == "ins") {
//insert into t_se table new group
			req.cmdPack[ind] = {cmd:"insert", table:"t_se"};
			req.cmdPack[ind].cols = ["name","state"];
			req.cmdPack[ind++].vals = [groupname, "on"];

// check and insert all members as single se
			for (j=0; j<members.length; j++) {
				if (typeof se[members[j].member] == "undefined") {
//insert into t_se table new group member
					req.cmdPack[ind] = {cmd:"insert", table:"t_se"};
					req.cmdPack[ind].cols = ["name","state"];
					req.cmdPack[ind++].vals = [members[j].member, "on"];
				}
//insert into t_group_member table new group member
			req.cmdPack[ind] = {cmd:"insert", table:"t_group_members"};
			req.cmdPack[ind].cols = ["groupname","member"];
			req.cmdPack[ind++].vals = [groupname, members[j].member];
			}		
		} else {
// delete all members for current group
			req.cmdPack[ind] = {cmd:"delete", table:"t_group_members"};
			req.cmdPack[ind].keyNames = ["groupname"];
			req.cmdPack[ind++].keyValues = [groupname];

			for (j=0; j<members.length; j++) {
				if (typeof se[members[j].member] == "undefined") {
//insert into t_se table new group member if it does not exist
					req.cmdPack[ind] = {cmd:"insert", table:"t_se"};
					req.cmdPack[ind].cols = ["name","state"];
					req.cmdPack[ind++].vals = [members[j].member, "on"];
				}

//insert into t_group_member table new group member
				req.cmdPack[ind] = {cmd:"insert", table:"t_group_members"};
				req.cmdPack[ind].cols = ["groupname","member"];
				req.cmdPack[ind++].vals = [groupname, members[j].member];
			}		
		}		
	}
	var ret = ui_req_s("cmdModify", req);
	if (typeof ret == "number") return printErr("CGI Error " + ret);
	if (ret.status != 0) return printErr("Error : " + ret.retMsg + "\nReason : " + ret.retNative);
	if (param.mode == "ins") {
		window.opener.gtables["t_se_groups"].refreshData();
		window.opener.gtables["t_se"].refreshData();
	} else {
//		window.opener.gtables["t_se_groups"].refreshRow(out, param["ind"]);
		window.opener.gtables["t_se_groups"].refreshData();
		window.opener.gtables["t_se"].refreshData();
	}
	closeWin();
	return;
}

function init() {
	var tmp1={};
	var tmp2={};
	var el, i ,j;

	var path = decodeURI(location.search.toString());
	i = path.indexOf("?");
	if(i == -1) return false;

	tmp1 = (path.substr(1)).split('&');
	for(i=0; i < tmp1.length; i++){
		tmp2 = tmp1[i].split('=');
		param[tmp2[0]] = tmp2[1];
	}

	if (param.mode == "ins") {
		$("groupname").disabled = false;
		return true;
	}
	data = JSON.parse(param["data"]);

	var tb = $("group");
	tb.rows[0].cells[1].firstChild.value = data.groupname;

	for (j=0; j<data.members.length; j++) {
		add_member(tb, data.members[j].member);		
	}

	if (param.mode == "del") {
		$("curtain").style.display = "block";
		if (confirm("Current group will be deleted.\nAre you agree?")) {
			var req = {"cmdPack":[]};
// delete all group members
			req.cmdPack[0] = {cmd:"delete", table:"t_group_members"};
			req.cmdPack[0].keyNames = ["groupname"];
			req.cmdPack[0].keyValues = [data.groupname];

			var ret = ui_req_s("cmdModify", req);
			if (typeof ret == "number") {
				alert("CGI Error " + ret);
			} else if (ret.status != 0) {
				alert ("Error : " + ret.retMsg + "\nReason : " + ret.retNative );
			} else {	
//				window.opener.gtables["t_group_members"].delRow(param["ind"]);
				window.opener.gtables["t_se_groups"].refreshData();
			}
		}
		closeWin();
	}
	return true;
}
}
</script>
<style>

html {
        overflow: auto;
}
body{
        font-family: Verdana, Arial, Helvetica, sans-serif;
        font-size: 0.9em;
        text-align:justify;
        color:darkblue;
        background-color:#CCFFCC;
}

table.out{
	border: 0;
	width: 100%;
	margin-left: auto;
	margin-right: auto;
}

table.out td{
	border: 1px solid;
	vertical-align: top;
}

table.in{
	border:  0;
	width: 100%;
	margin-left: 0;
	margin-right: 0;
}
table.in td{
	border:  0;
	vertical-align: top;
}

th.center {
	text-align: center;
}
#curtain {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    z-index: 999; /* to avoid overlapping with other elements */
    background: gainsboro;
    opacity: 0.1;
    display: none;
}

</style>

</head><body onload="init()">
<div id="curtain"></div>
<form>
<table class="out">
<tbody>
<tr><td colspan="2">
	<table class="in" id="group">
	<tbody>
	<tr><th>Group name</th><td colspan="2"><input type="text" size="30" disabled="true" id="groupname" /></td></tr>
	<tr><th>Member</th><td><input type="text" size="30" style="backgroundColor:#FFFF66" /></td><td width="0"><a id="add" onclick="add_new_member(this.parentNode.parentNode.parentNode)"><img src="img/plus.gif" width="13px" height="13px"/></a></td></tr>
	</tbody></table>
</td></tr>
<tr><th class="center"><input type="button" value="Save" onclick="saveData()" /></th><th class="center"><input type="button" value="Cancel" onclick="closeWin()" /></th></tr>
</tbody></table>
</form>
</div>
</body></html>
