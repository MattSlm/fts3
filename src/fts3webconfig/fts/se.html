<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>SE config</title>

<script type="text/javascript" src="data.js"></script>
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="ui.js"></script>
<script type="text/javascript">
{

var param = {};

function hasClass(elem, className) {
        return new RegExp("(^|\\s)"+className+"(\\s|$)").test(elem.className);
}
function $(id) {
	return (typeof id == "string" ) ? document.getElementById(id) : id;
}
function trims (val) {
	return val.replace(/^\s+|\s+$/g,'');
}
function isnum(val) {
	return !isNaN(+val);
}
function printErr (msg) {
	alert(msg);
	return false;
}

function checkInput() {
	var out = {};
	var fidn, fidv, el;
	if ($("name").style.display == "block" ) {
		name = $("name").value;
	} else if ($("sel_name").selectedIndex != -1) {
		name = $("sel_name").options[$("sel_name").selectedIndex].value;
	} else {
		return printErr("SE name is not selected");
	}

	if (trims(name).length == 0)  return printErr("Empty SE name");
	out.name = name;

	el = $("state");
	if (el.options[el.selectedIndex].value == "") return printErr("Undefined state for SE ");
	out.state = el.options[el.selectedIndex].value;

	var cons = {"in_":"Inbound", "out_":"Outbound"};
	out.connections = [];
	for (var key in cons) {
		var tcon = {};
		for (var j=0; j<$(key + "connections").rows.length; j++) {
			el = $(key+ "connections").rows[j];
			fidn = el.cells[1].firstChild.id;
			fidn = fidn.substr(fidn.indexOf("_") + 1);
			var fval = el.cells[1].firstChild;
			if (fval.tagName == "INPUT") {
				fidv = trims(fval.value);
				if (!hasClass(fval, "canbenull") && (fidv.length == 0)) return printErr("Empty value in " + el.cells[0].innerHTML.replace(/&nbsp;/g, " ") + " for " + cons[key] + " section");
				if (hasClass(fval, "int") && !isnum(fidv)) return printErr("Invalid value in " + el.cells[0].innerHTML.replace(/&nbsp;/g, " "));
			} else {
				if (fval.selectedIndex == -1 || !fval.options[fval.selectedIndex].value) return printErr("State for " + cons[key] + " section is not selected");
				fidv = fval.options[fval.selectedIndex].value;
			}
			tcon[fidn] = fidv; 
		}
		if ($(key + "share").rows.length == 1) return printErr("At least one VO and active fields should be defined for "  + cons[key] + " section" );

		tcon.share = [];
		el = $(key + "share");

		for (var i=1; i<el.rows.length; i++) {
			var tshare = {};
			tshare.vo = el.rows[i].cells[0].innerHTML;
			tshare.active = el.rows[i].cells[1].firstChild.value;
			tcon.share.push(tshare);
		}
		out.connections.push(tcon);
	}
	return out;
}

function switchName(name) {
	var els = document.getElementsByName(name);
	for (var i=0; i<els.length; i++) {
		if (els[i].checked) {
			if (els[i].value == "1") {
				$("sel_name").style.display = "block";
				$("name").style.display = "none";
			} else {
				$("sel_name").style.display = "none";
				$("name").style.display = "block";
			}
			break;
		}
	}
	return true;
}
// special case for state connection dependence
function setState(fld) {
	var str = fld.options[fld.selectedIndex].value;
	$("in_lstate").value = str;
	$("out_lstate").value = str;
	return;
}
function setConn(fld) {
	var str;
	if (fld.style.display == "none" ) return true;

	if (fld.tagName == "SELECT") {
		str = fld.options[fld.selectedIndex].value;
	} else {
		str = fld.value;
	}
	// remove whitespace from both ends of the string
	str = str.replace(/^\s+|\s+$/g,'');
	if (str.length == 0) return true;
// special case for * field in SE name field
	if (str == "*") {
		str = "(*)";
		fld.value = str;
	}
	$("in_source").value = "*";
	$("in_destination").value = str;
	$("in_symbolicname").value = "*-" + str;
	$("out_source").value = str;
	$("out_destination").value = "*";
	$("out_symbolicname").value = str +"-*";
	return true;
}
function closeWin(){
	if (window.opener.wndPop)	{
		window.opener.focus();
		window.opener.wndPop = null;
		setTimeout(function(){window.close()}, 100); // KHTML workaround
	}
	return true;
}

function add_new_share(tb) {
	var trow = tb.rows[0];
	var dt = {};

	dt.vo = trims(trow.cells[0].firstChild.value);
	dt.active = trims(trow.cells[1].firstChild.value);
	if (!dt.vo || !dt.active) return printErr("VO and active fields could not be empty");
	if (!isnum(dt.active), false) return printErr("Invalid active value");
	for (var i=1; i<tb.rows.length; i++) {
		if (tb.rows[i].cells[0].innerHTML.toLowerCase() == dt.vo.toLowerCase()) return printErr("Duplicated VO name");
	}
	add_share(tb, dt);
	trow.cells[0].firstChild.value = "";
	trow.cells[1].firstChild.value = "";
	return true;
}

function add_share(tb, dt) {
	var trow, tcell, tinp, tlink, timg;
	if (!dt.vo) return false;

	trow = tb.insertRow(-1);
	tcell = trow.insertCell(-1);
	tcell.innerHTML = dt.vo.toLowerCase();
	tcell = trow.insertCell(-1);
	tinp = document.createElement("INPUT");
	tcell.appendChild(tinp);
	tinp.size = "10";
	tinp.value = dt.active;
	tcell = trow.insertCell(-1);
	tlink = document.createElement("A");
	tlink.onclick = function() {tb.deleteRow(trow.rowIndex-1)};
	tcell.appendChild(tlink);
	timg = document.createElement("IMG");
	timg.src = "img/minus.gif";
	timg.width = "13";
	timg.height = "13";
	tlink.appendChild(timg);
	return true;
}

function saveData() {
	var i,j;
	var out = checkInput();
	if (typeof out == "boolean") return false;

	var req = {};
	req.cmdPack = [];
	var ind = 0;
	if (param.mode == "ins") {
// for new SE	
// insert SE
		req.cmdPack[ind] = {cmd:"insert", table:"t_se"};
		req.cmdPack[ind].cols = ["name","state"];
		req.cmdPack[ind].vals = [out.name, out.state];
		ind++;
// for all connections
		for (i=0; i<out.connections.length; i++) {
			with (out.connections[i]) {
// insert connection
				req.cmdPack[ind] = {cmd:"insert", table:"t_link_config"};
				req.cmdPack[ind].cols = ["source","destination","state", "symbolicname", "nostreams", "tcp_buffer_size", "urlcopy_tx_to", "no_tx_activity_to"];
				req.cmdPack[ind].vals = [source, destination, lstate, symbolicname, nostreams, tcp_buffer_size, urlcopy_tx_to, no_tx_activity_to];
				ind++;

				if (typeof out.connections[i].share == "undefined") continue;
				for (j=0; j<share.length; j++) {
// insert all shares
					req.cmdPack[ind] = {cmd:"insert", table:"t_share_config"};
					req.cmdPack[ind].cols = ["source","destination", "vo", "active"];
					req.cmdPack[ind].vals = [source, destination, share[j].vo, share[j].active];
					ind++;
				}						
			}
		}
	} else {
// for existed SE & connections data
// update state
		req.cmdPack[ind] = {cmd:"update", table:"t_se"};
		req.cmdPack[ind].cols = ["state"];
		req.cmdPack[ind].vals = [out.state];
		req.cmdPack[ind].keyNames = ["name"];
		req.cmdPack[ind].keyValues = [out.name];
		ind++;
// for all connections
		for (i=0; i<out.connections.length; i++) {
			with (out.connections[i]) {

// delete all shares for definite connection, if they exist
				req.cmdPack[ind] = {cmd:"delete", table:"t_share_config"};
				req.cmdPack[ind].keyNames = ["source","destination"];
				req.cmdPack[ind].keyValues = [source,destination];
				ind++;

// update (delete/insert) connections
				req.cmdPack[ind] = {cmd:"delete", table:"t_link_config"};
				req.cmdPack[ind].keyNames = ["source","destination"];
				req.cmdPack[ind].keyValues = [source,destination];
				ind++;

				req.cmdPack[ind] = {cmd:"insert", table:"t_link_config"};
				req.cmdPack[ind].cols = ["source", "destination","state","symbolicname", "nostreams", "tcp_buffer_size", "urlcopy_tx_to", "no_tx_activity_to"];
				req.cmdPack[ind].vals = [source, destination, lstate, symbolicname, nostreams, tcp_buffer_size, urlcopy_tx_to, no_tx_activity_to];
				ind++;


				if (typeof out.connections[i].share == "undefined") continue;
				for (j=0; j<share.length; j++) {
// inser all shares for define connection
					req.cmdPack[ind] = {cmd:"insert", table:"t_share_config"};
					req.cmdPack[ind].cols = ["source","destination", "vo", "active"];
					req.cmdPack[ind].vals = [source, destination, share[j].vo, share[j].active];
					ind++;
				}						
			}		
		}
	}

	var ret = ui_req_s("cmdModify", req);
	if (typeof ret == "number") {                                                            
		alert("CGI Error " + ret);
		return false;                                                                    
	}
	if (ret.status != 0) {
		alert ("Error : " + ret.retMsg + "\nReason : " + ret.retNative + "\n" + ret.query+ "\n" + ret.bind);
		return false;
	}
	if (param.mode == "ins") {
		window.opener.gtables["t_se"].refreshData();
	} else {
		window.opener.gtables["t_se"].refreshData();
//		window.opener.gtables["t_se"].refreshRow(out, param["ind"], param["len"]);
	}
	closeWin();
	return;
}

function init() {
	var tmp1={};
	var tmp2={};
	var el, i ,j, k;

	var path = decodeURI(location.search.toString());
	i = path.indexOf("?");
	if(i == -1) return false;

	tmp1 = (path.substr(1)).split('&');
	for(i=0; i < tmp1.length; i++){
		tmp2 = tmp1[i].split('=');
		param[tmp2[0]] = tmp2[1];
	}

	if (param.mode == "ins") {
		$("grp_sel").style.display = "block";
		var req={};
		req.cmd = "cmdSelect";
		req.query = queries["t_group_new"] + " order by " + sorts["t_group_new"];
		req.bind = 0;
		var ret = ui_req_s("cmdSelect", req);
		if (typeof ret == "number") return;
		if (ret.status != 0) {
			alert ("Error : " + ret.retMsg + "\nReason : " + ret.retNative + "\n" + ret.query+ "\n" + ret.bind);
		} else {
			if (ret.rowNum == 0) return true;
			for (i=0; i<=ret.data.length; i++) {
				var opt = document.createElement("OPTION");
				if (i == 0){
					opt.text = "";
					opt.value = "";
					opt.selected = true;		// Empty by default
				} else {
					opt.text = ret.data[i-1].name;
					opt.value = ret.data[i-1].name;
				}
				try {
					$("sel_name").add(opt, null);
				} catch(e) {
					$("sel_name").add(opt);
				}
			}
		}
		return true;
	}
	var data = JSON.parse(param["data"]);

	$("name").disabled = true;
	$("grp_sel").style.display = "none";

// fill input data fields
	$("name").value = data.name;

	el = $("state");
	for (k=0; k<el.options.length; k++) {
		if (el.options[k].value == data.state) {
			el.options[k].selected = true;
			break;
		}
	}

	if (!data.connections) return false;
	for (i=0; i<data.connections.length; i++) {
		if (!data.connections[i].source) {
			setConn($("name"));
			setState($("state"));
			break;
		}
		var s = (data.connections[i].source == "*") ? "in_" : "out_";
		var tb = $( s + "connections");

		for ( j=0; j<tb.rows.length; j++) {
			el = tb.rows[j].cells[1].firstChild;
			var st = el.id;
			var nm = st.substr(st.indexOf("_") + 1);
			if (el.tagName == "INPUT") {
				el.value = data.connections[i][nm];
			} else {
				for (k=0; k<el.options.length; k++) {
					if (el.options[k].value == data.connections[i][nm]) {
						el.options[k].selected = true;
						break;
					}
				}
			}
		}
		tb = $( s + "share");
		for (j=0; j<data.connections[i].share.length; j++) {
			add_share(tb, data.connections[i].share[j]);		
		}
	}
	if (param.mode == "del") {
		$("curtain").style.display = "block";
		if (confirm("Current configuration and all associated data will be deleted.\nAre you agree?")) {
			var req = {"cmdPack":[]};
			var ind = 0;

			if (data.connections) {
				for (i=0; i<data.connections.length; i++) {
// delete all shares for connection
					req.cmdPack[ind] = {cmd:"delete", table:"t_share_config"};
					req.cmdPack[ind].keyNames = ["source","destination"];
					req.cmdPack[ind++].keyValues = [data.connections[i].source,data.connections[i].destination];
// delete connection config
					req.cmdPack[ind] = {cmd:"delete", table:"t_link_config"};
					req.cmdPack[ind].keyNames = ["source","destination"];
					req.cmdPack[ind++].keyValues = [data.connections[i].source,data.connections[i].destination];
				}
// set se state to on
				req.cmdPack[ind] = {cmd:"update", table:"t_se"};
				req.cmdPack[ind].cols = ["state"];
				req.cmdPack[ind].vals = ["on"];
				req.cmdPack[ind].keyNames = ["name"];
				req.cmdPack[ind++].keyValues = [data.name];

				var ret = ui_req_s("cmdModify", req);
				if (typeof ret == "number") {
					alert("CGI Error " + ret);
				} else if (ret.status != 0) {
					alert ("Error : " + ret.retMsg + "\nReason : " + ret.retNative );
				} else {	
//					window.opener.gtables["t_se"].delRow(param["ind"], param["len"]);
					window.opener.gtables["t_se"].refreshData();

				}
			}
		}
		closeWin();
	}
}

}
</script>
<style>


html {
        overflow: auto;
}

body{
        font-family: Verdana, Arial, Helvetica, sans-serif;
        font-size: 0.9em;
        text-align:justify;
        color:darkblue;
        background-color:#CCFFCC;
}

table.out{
	border: 0;
	width: 100%;
	margin-left: auto;
	margin-right: auto;
}

table.out td{
	border: 1px solid;
	vertical-align: top;
}

table.in{
	border:  0;
	width: 100%;
	margin-left: 0;
	margin-right: 0;
}
table.in td{
	border:  0;
	vertical-align: top;
}
th.center {
	text-align: center;
}
#curtain {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    z-index: 999; /* to avoid overlapping with other elements */
    background: gainsboro;
    opacity: 0.1;
    display: none;
}
</style>

</head><body onload="init()">
<div id="curtain"></div>
<div>
<form>
<table class="out">
<tbody>
<tr>
<td colspan=2>
	<table class="in"><colgroup><col width="0"></col><col></col><col width="0"></col></colgroup> 
	<tr><td>SE&nbsp;name:</td><td><input type="text" size="30" id="name" style="display:block" onchange="setConn(this)"/><select size="1" style="width:250px;display:none" id="sel_name" onchange="setConn(this)"></select></td>
		<td rowspan="2">
			<table class="in" id="grp_sel"><thead><tr><th>Is&nbsp;group?</th></tr></thead>
			<tbody>
				<tr><td><input type="radio" name="grp" value="1" onclick="switchName(this.name)" />Yes</td></tr>
				<tr><td><input type="radio" name="grp" value="0" checked="true" onclick="switchName(this.name)"/>No</td></tr>
			</tbody></table>
		</td></tr>
	<tr><td>State&nbsp;(on/off):</td><td><select id="state" onchange="setState(this)"><option value="" selected></option><option value="on">on</option><option value="off">off</option></select></td></tr>
	</table>
</td>
</tr>
<tr><th>Inbound</th><th>Outbound</th></tr>
<tr>
	<td>
	<table class="in">
	<tbody id="in_connections">
		<tr><td>Source</td><td><input type="text" size="30" disabled="true" id="in_source" /></td></tr>
		<tr><td>Destination</td><td><input type="text" size="30" disabled="true" id="in_destination"/></td></tr>
		<tr><td>Name</td><td><input type="text" size="30" disabled="true" id="in_symbolicname" /></td></tr>
		<tr><td>State</td><td><input type="text" size="10" disabled="true" id="in_lstate" /></td></tr>
		<tr><td>Number&nbsp;of&nbsp;streams</td><td><input type="text" size="10" class="int" id="in_nostreams" /></td></tr>
		<tr><td>TCP&nbsp;buffer&nbsp;size</td><td><input type="text" size="10" class="int canbenull" id="in_tcp_buffer_size" /></td></tr>
		<tr><td>Timeout</td><td><input type="text" size="10" class="int" id="in_urlcopy_tx_to" /></td></tr>
		<tr><td>No activity timeout</td><td><input type="text" size="10" class="int canbenull" id="in_no_tx_activity_to"/></td></tr>
	</tbody>
	</table>
	</td>
	<td>
	<table class="in">
	<tbody id="out_connections">
		<tr><td>Source</td><td><input type="text" size="30" disabled="true" id="out_source" /></td></tr>
		<tr><td>Destination</td><td><input type="text" size="30" disabled="true" id="out_destination"/></td></tr>
		<tr><td>Name</td><td><input type="text" size="30" disabled="true" id="out_symbolicname" /></td></tr>
		<tr><td>State</td><td><input type="text" size="10" disabled="true" id="out_lstate" /></td></tr>
		<tr><td>Number&nbsp;of&nbsp;streams</td><td><input type="text" size="10" class="int" id="out_nostreams" /></td></tr>
		<tr><td>TCP&nbsp;buffer&nbsp;size</td><td><input type="text" size="10" class="int canbenull" id="out_tcp_buffer_size" /></td></tr>
		<tr><td>Timeout</td><td><input type="text" size="10" class="int" id="out_urlcopy_tx_to" /></td></tr>
		<tr><td>No activity timeout</td><td><input type="text" size="10" class="int canbenull" id="out_no_tx_activity_to"/></td></tr>
	</tbody>
	</table>
	</td>
</tr>
<tr><th>Share</th><th>Share</th></tr>
<tr>
	<td>
	<table class="in">
	<thead><tr><th>VO</th><th>Active</th><th>&nbsp;</th></tr></thead>
	<tbody id="in_share">
		<tr><td><input type="text" size="10" /></td><td><input type="text" size="10" /></td><td width="0"><a id="in_add" onclick="add_new_share(this.parentNode.parentNode.parentNode)"><img src="img/plus.gif" width="13px" height="13px"/></a></td></tr>
	</tbody>
	</table>
	</td>
	<td>
	<table class="in">
	<thead><tr><th>VO</th><th>Active</th><th>&nbsp;</th></tr></thead>
	<tbody id="out_share">
		<tr><td><input type="text" size="10" /></td><td><input type="text" size="10" /></td><td  width="0"><a id="out_add" onclick="add_new_share(this.parentNode.parentNode.parentNode)"><img src="img/plus.gif" width="13px" height="13px"/></a></td></tr>
	</tbody>
	</table>
	</td>
</tr>
<tr><th class="center"><input type="button" value="Save" onclick="saveData()" /></th><th class="center"><input type="button" value="Cancel" onclick="closeWin()" /></th></tr>
</tbody></table>
</form>
</div>
</body></html>
